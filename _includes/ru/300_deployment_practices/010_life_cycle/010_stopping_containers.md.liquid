При остановке контейнера всем процессам в нём отправляется сигнал, указанный в `STOPSIGNAL` (обычно это `TERM`). Но не все приложения умеют правильно реагировать на него и делать graceful shutdown, который бы корректно отработал и для приложения, запущенного в Kubernetes.

Например, чтобы сделать корректную остановку nginx, нам понадобится preStop-хук вроде этого:

```yaml
lifecycle:
  preStop:
    exec:
      command:
      - /bin/sh
      - -ec
      - |
        sleep 3
        nginx -s quit
```

1. `sleep 3` здесь для страховки от race conditions, связанных с удалением endpoint; 

1. `nginx -s quit` инициирует корректное завершение работы для nginx. Хотя в свежих образах nginx эта строка больше не понадобится, т. к. там `STOPSIGNAL: SIGQUIT` установлен по умолчанию.

> Более подробно про graceful shutdown для nginx в связке с PHP-FPM вы можете узнать из [этой](https://habr.com/ru/company/flant/blog/489994/) статьи.

Корректно ли ваше приложение обработает `STOPSIGNAL`, зависит только от него. На практике для большинства приложений приходится гуглить, как оно обрабатывает указанный для него `STOPSIGNAL`. И если оказывается, что не так, как надо, то делается preStop-хук, который эту проблему решает, либо же `STOPSIGNAL` меняется на тот, который приложение сможет обработать корректно и штатно завершиться.

Ещё один важный параметр, связанный с остановкой приложения, — `terminationGracePeriodSeconds`. Он отвечает за то, сколько времени будет у приложения на корректное завершение. Если приложение не успеет завершиться в течение этого времени (30 секунд по умолчанию), то приложению будет послан сигнал `KILL`. Таким образом, если вы ожидаете, что выполнение preStop-хука и/или завершение работы приложения при получении `STOPSIGNAL` могут занять более 30 секунд, то `terminationGracePeriodSeconds` нужно будет увеличить. Например, такое может потребоваться, если некоторые запросы у клиентов веб-сервиса долго выполняются (вроде запросов на скачивание больших файлов).

Стоит заметить, что preStop-хук выполняется блокирующе, т. е. `STOPSIGNAL` будет послан только после того, как preStop-хук отработает. Тем не менее, отсчет `terminationGracePeriodSeconds` идёт и в течение работы preStop-хука. А процессы, запущенные в хуке, равно как и все процессы в контейнере, получат сигнал `KILL` после того, как `terminationGracePeriodSeconds` закончится.

Также у некоторых приложений встречаются специальные настройки, регулирующие время, в течение которого приложение должно завершить свою работу (к примеру, опция `--timeout` у Sidekiq). Оттого для каждого приложения надо убеждаться, что если у него есть подобная настройка, то она выставлена в значение немного меньшее, чем `terminationGracePeriodSeconds`.
