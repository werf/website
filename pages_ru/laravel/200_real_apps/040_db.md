---
title: Работа с базой данных
permalink: laravel/200_real_apps/040_db.html
examples_initial: examples/laravel/030_assets
examples: examples/laravel/040_db
base_url: https://github.com/werf/werf-guides/blob/master/
description: |
  В этой главе мы развернём базу данных, реализуем в приложении работу с БД и настроим автоматическое выполнение миграций и инициализации БД.
---

## Подготовка stateful-приложения

Сейчас наше приложение не использует БД и не хранит никаких данных (т.е. stateless). Поэтому, чтобы сделать его stateful, нам в первую очередь нужно добавить в его образ соответствующие компоненты и подготовить приложение к работе с MySQL, которую мы будем использовать для хранения состояния.

Основные изменения, сделанные в нашем приложении:
1. Добавление `mysql-client` и php-модуля `pdo_mysql` в [Dockerfile]({{ page.base_url | append: page.examples | append: "/Dockerfile" }}).

## Добавление endpoints `/remember` и `/say` в приложение

Добавим два новых endpoints, один из которых будет сохранять данные в БД (`/remember`), а второй — доставать их из БД (`/say`).

Наш новый контроллер и модель:
{% include snippetcut_example path="app/Http/Controllers/TalkerController.php" syntax="php" examples=page.examples %}
{% include snippetcut_example path="app/Models/Talker.php" syntax="php" examples=page.examples %}

Добавим новые пути в список маршрутов:
{% include snippetcut_example path="routes/web.php" syntax="php" examples=page.examples %}

Также добавим две простых миграции:
{% include snippetcut_example path="database/migrations/2021_10_04_000000_create_talkers_table.php" syntax="php" examples=page.examples %}
{% include snippetcut_example path="database/migrations/2021_10_04_000001_add_name_to_talkers.php" syntax="php" examples=page.examples %}

Новые endpoints — `/remember` и `/say` — готовы к работе.

## Развертывание и подключение MySQL

В реальной инфраструктуре базы данных могут быть развернуты как в Kubernetes, так и вне его. Вне Kubernetes базы данных могут развертываться и обслуживаться самостоятельно, либо могут использоваться managed-решения вроде Amazon RDS. Для нашего приложения, в целях демонстрации, мы развернём БД MySQL в Kubernetes с помощью простого StatefulSet:
{% include snippetcut_example path=".helm/templates/database.yaml" syntax="yaml" examples=page.examples %}
>_Вы также можете использовать базы данных развернутые любым другим способом. В таком случае вам не нужно развертывать вышеупомянутый StatefulSet, все же дальнейшие инструкции остаются без изменений._

Теперь настроим приложение на работу с новой БД:
{% include snippetcut_example path=".helm/templates/deployment.yaml" syntax="yaml" snippet="database-config" examples=page.examples %}

БД и приложение готовы к развертыванию.

## Инициализация и миграции БД

Есть несколько способов выполнять инициализацию и миграции БД при развертывании приложений в Kubernetes. Мы рассмотрим один простой, но хорошо работающий метод. В нем миграции БД (и, если требуется, инициализация) будут выполняться отдельной Job одновременно с развертыванием приложения и самой БД.

Чтобы выдержать очередность развертывания ресурсов, мы:
1. Требуем от Job, которая выполнит инициализацию/миграции БД, дождаться доступности базы данных перед началом работы.
1. Требуем от приложений перед тем, как запуститься, дождаться доступности базы данных _и_ подготовки базы данных _и_ выполнения миграций.

Таким образом, при деплое все K8s-ресурсы будут созданы одновременно, но начнут работу в следующем порядке:
1. Запустится БД.
1. Затем выполнится Job с инициализацией/миграциями БД.
1. Затем запустятся приложения.

Реализуем это, добавив Job для выполнения миграций/инициализации базы данных:
{% include snippetcut_example path=".helm/templates/job-migrate-db.yaml" syntax="yaml" examples=page.examples %}

{% offtopic title="Зачем ждать выполнения 10 подряд успешных проверок доступности БД?" %}
Это предохраняет нас от случая, когда `mysqladmin ping` выполняется только один раз и до того, как StatefulSet с MySQL начнёт перезапускаться при деплое. В таких случаях во время выполнения инициализации/миграций база данных может оказаться недоступна.

Также в образах с БД при первом запуске главный процесс БД может несколько раз перезапускаться (при этом без перезапуска контейнера). В таком случае, если проверять БД на доступность только один раз, то может оказаться, что после успешной однократной проверки запускаются миграции/инициализация в то же время, когда начинает перезапускаться сам процесс БД. От этого нас тоже страхует выполнение `mysqladmin ping` несколько раз подряд.

Количество успешных проверок подряд можно изменять — значение 10 приведено как пример.
{% endofftopic %}

## Проверка работы приложения и БД

Развернём приложение:
```shell
werf converge --repo <имя пользователя Docker Hub>/werf-guide-app
```

Ожидаемый результат:
{% include snippetcut_example path="werf-converge.log" syntax="shell" examples=page.examples %}

Попробуем обратиться на `/say`, который должен попытаться достать данные из БД:
```shell
curl http://werf-guide-app/say
```

Но так как в базе данных пока пусто, должно вернуться следующее:
```shell
I have nothing to say.
```

Тогда сохраним данные в БД через `/remember`:
```shell
curl "http://werf-guide-app/remember?answer=Love+you&name=sweetie"
```

Ожидаемый результат, означающий, что данные сохранены:
```shell
Got it.
```

Снова попробуем получить данные из БД через `/say`:
```shell
curl http://werf-guide-app/say
```

Ожидаемый успешный результат:
```shell
Love you, sweetie!
```

Также мы можем убедиться, что данные в базе действительно сохранены, запросив напрямую из БД содержимое таблицы:
```shell
kubectl exec -it statefulset/mysql -- mysql -ppassword -e "SELECT * from talkers" werf-guide-app
```

Ожидаемый результат:
```shell
+----+----------+---------------------+---------------------+---------+
| id | answer   | created_at          | updated_at          | name    |
+----+----------+---------------------+---------------------+---------+
|  1 | Love you | 2021-10-08 12:46:22 | 2021-10-08 12:46:22 | sweetie |
+----+----------+---------------------+---------------------+---------+
```

Готово!

Итогом этой главы стала реализация stateful-приложения, развертывание базы данных вместе с этим приложением, а также автоматическая инициализация БД и выполнение миграций. Подобный подход должен хорошо работать с любыми реляционными БД.

_Как и прежде, увидеть все сделанные в этой главе изменения вы можете, выполнив команды, описанные [в начале главы](#подготовка-репозитория)._
